<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/index.css">
  <title>Index</title>
</head>
<body>
  <!-- Header -->
  <header class="l-header">
    <div class="nav">
      <div class="nav__brand u-text-headline u-c-pri-70">台北一日遊</div>
      <div class="nav__menu">
        <button class="nav__btn u-text-body u-c-sec-70 u-bg-white">預定行程</button>
        <button class="nav__btn u-text-body u-c-sec-70 u-bg-white">登入/註冊</button>
      </div>
    </div> 
  </header>
  <!-- Hero -->
  <div class="l-hero">
    <!-- Hero BG img -->
    <img class="hero__img" src="/static/welcome.png">
    <!-- Hero content -->
    <div class="hero__content">
      <!-- Hero slogan -->
      <div class="hero__slogan">
        <div class="hero__title u-c-white u-text-sloganTitle">輕鬆享受台北一日悠閒</div>
        <div class="hero__subtitle u-c-white u-text-body--bold">探索每個角落，體驗城市的深度旅遊行程</div>
      </div>
      <!-- Hero search bar -->
      <div class="hero__search">
        <div class="search">
          <button class="search__categories-btn u-text-body">全部分類▼</button>
          <input class="search__input u-text-body--bold" placeholder="輸入景點名稱查詢" id="search__input">
          <button class="search__btn">
            <img class="search__icon" src="/static/icon_search.png">
          </button>
        </div>
      </div>
      <div class="category__menu u-bg-white">
        <div class="category__item u-text-category">全部分類</div>

      </div>
    </div>
  </div>
  <!-- Atrractions area -->
  <div class="l-attractions">
    <!-- Atrraction list bar -->
    <div class="listBar u-bg-white">
      <div class="listBar__nav--left">
        <button class="listBar__btn u-bg-white" id="listBar-left-btn">
          <img class="listBar__icon" src="/static/left-btn.png">
        </button>
      </div>
      <div class="listBar__viewport">
        <div class="listBar__list">
          <!-- JS填充 -->
        </div>
      </div>
      <div class="listBar__nav--right">
        <button class="listBar__btn u-bg-white" id="listBar-right-btn">
          <img class="listBar__icon" src="/static/right-btn.png">
        </button>
      </div>
    </div>
    <!-- Card grid  -->
    <div class="cardGrid">
      <!-- Card 填充物 -->
      <!-- 填充物範本 
      <div class="card u-c-white">
        <div class="card__media">
          <img class="card__img" src="">
          <div class="card__title">
            <div class="card__titleText u-text-body--bold u-c-white">平安鐘</div>
          </div>
        </div>
        <div class="card__detail">
          <div class="card__info card__info--mrt u-text-body u-c-sec-50">忠孝復興</div>
          <div class="card__info card__info--category u-text-body u-c-sec-50">公共藝術</div>
        </div>
      </div>  
      -->
      
    </div>
  </div>
  <div id="sentinel"></div>
  <!-- Footer -->
  <div class="l-footer u-bg-sec-50">
    <div class="footer__text u-text-body--bold u-c-white">COPYRIGHT © 2021 台北一日遊</div>
  </div>
  <script defer>
    const bar = document.querySelector('.listBar');
    const listBar_list = bar.querySelector('.listBar__list');
    const left_btn = bar.querySelector('#listBar-left-btn');
    const right_btn = bar.querySelector('#listBar-right-btn');
    const category_menu = document.querySelector('.category__menu');
    const search_categories_btn = document.querySelector('.search__categories-btn');
    const search_input = document.querySelector('#search__input');
    const sentinel = document.querySelector('#sentinel');


    // 計算每次滑動的位移量，clientWidth：該元素「可視內容看」的寬度
    function step(){
      return listBar_list.clientWidth * 2 / 3;
    }
    
    left_btn.addEventListener('click',() => {
      listBar_list.scrollBy({left: -step(), behavior: "smooth"});
    });
    // scrollBy：相對捲動，left：水平捲動位移量
    right_btn.addEventListener('click',() => {
      listBar_list.scrollBy({left: step(), behavior: "smooth"});
    });

    async function get_data(url) {
      const res = await fetch(url);
      const ct = res.headers.get('content-type') || '';
      const body = ct.includes('application/json') ? await res.json() : await res.text();

      if (!res.ok){
        const err = new Error (`HTTP ${res.status}`);
        err.status = res.status;
        err.payload = body;
        throw err;
      }
      return body;
    }

    async function startup(){
      // Fetch List bar
      try{
        const result = await get_data("/api/mrts");
        const data = result.data;
        data.forEach(d => {
          // create list bar item
          const listBar_item = document.createElement('div');
          listBar_item.classList = "listBar__item u-text-body u-c-sec-70";
          listBar_item.textContent = d;
          listBar_list.append(listBar_item);
          // item function: put mrt into search input
          listBar_item.addEventListener('click', () => {
            search_input.value = listBar_item.textContent;
          });
        });
      }catch(e){
        console.log(e)
      }

      // Fetch Attraction
      // try{
      //   const result = await get_data("/api/attractions?page=0");
      //   const data = result.data;
      //   console.log(data);
      //   const card_grid = document.querySelector('.cardGrid')
      //   data.forEach(d => {
      //     // card__caontainer
      //     const card_title_text = document.createElement('div');
      //     card_title_text.classList = "card__titleText u-text-body--bold u-c-white";
      //     card_title_text.textContent = d.name;
      //     const card_title = document.createElement('div');
      //     card_title.classList = "card__title";
      //     card_title.append(card_title_text);
      //     const card_img = document.createElement('img');
      //     card_img.classList = "card__img";
      //     card_img.src = d.images[0];
      //     const card_media = document.createElement('div');
      //     card_media.classList = "card__media";
      //     card_media.append(card_img);
      //     card_media.append(card_title);
      //     // card__detail
      //     const card_info_mrt = document.createElement('div');
      //     card_info_mrt.classList = "card__info card__info--mrt u-text-body u-c-sec-50";
      //     card_info_mrt.textContent = d.mrt;
      //     const card_info_category = document.createElement('div');
      //     card_info_category.classList = "card__info card__info--category u-text-body u-c-sec-50";
      //     card_info_category.textContent = d.category;
      //     const card_detail = document.createElement('div');
      //     card_detail.classList = "card__detail";
      //     card_detail.append(card_info_mrt);
      //     card_detail.append(card_info_category);
      //     // card
      //     const card = document.createElement('div');
      //     card.classList = "card u-c-white";
      //     card.append(card_media);
      //     card.append(card_detail);
      //     // insert card
      //     card_grid.append(card);
      //   });
      // }catch(e){
      //   console.log(e);
      // }

      // Fetch Category Menu
      try{
        const result = await get_data("/api/categories");
        const data = result.data;
        data.forEach(d => {
          // create menu
          const category_item = document.createElement('div');
          category_item.classList = "category__item u-text-category";
          category_item.textContent = d;
          category_menu.append(category_item);
          // menu function: put category into search input
          category_item.addEventListener('click', () => {
            search_input.value = category_item.textContent;
            category_menu.classList.remove('category__menu--open')
          });
        });
      }catch(e){
        console.log(e);
      }

      // category menu event
      search_categories_btn.addEventListener('click', () => {
      category_menu.classList.toggle('category__menu--open');
      });

    }
    startup();

    
      // Fetch Attraction and build HTML
    async function build_attractions(url){
      try{
        const result = await get_data(url);
        const data = result.data;
        const card_grid = document.querySelector('.cardGrid')
        data.forEach(d => {
          // card__caontainer
          const card_title_text = document.createElement('div');
          card_title_text.classList = "card__titleText u-text-body--bold u-c-white";
          card_title_text.textContent = d.name;
          const card_title = document.createElement('div');
          card_title.classList = "card__title";
          card_title.append(card_title_text);
          const card_img = document.createElement('img');
          card_img.classList = "card__img";
          card_img.src = d.images[0];
          const card_media = document.createElement('div');
          card_media.classList = "card__media";
          card_media.append(card_img);
          card_media.append(card_title);
          // card__detail
          const card_info_mrt = document.createElement('div');
          card_info_mrt.classList = "card__info card__info--mrt u-text-body u-c-sec-50";
          card_info_mrt.textContent = d.mrt;
          const card_info_category = document.createElement('div');
          card_info_category.classList = "card__info card__info--category u-text-body u-c-sec-50";
          card_info_category.textContent = d.category;
          const card_detail = document.createElement('div');
          card_detail.classList = "card__detail";
          card_detail.append(card_info_mrt);
          card_detail.append(card_info_category);
          // card
          const card = document.createElement('div');
          card.classList = "card u-c-white";
          card.append(card_media);
          card.append(card_detail);
          // insert card
          card_grid.append(card);
        });
        return result.nextPage;
      }catch(e){
        console.log(e);
      }
    }


    // Load Attractions
    let page = 0;
    let loadding = false;
    let done = false;
    
    // Load more Function
    async function load_more(){
      // 避免無限重跑
      if (loadding || done) return;
      loadding = true;

      // 第一次觸發後先暫停觀察，避免長出的東西不夠把sentinel推到交集範圍外
      observer.unobserve(sentinel);
      // 執行build attractions
      try{
        const next_page = await build_attractions(`/api/attractions?page=${page}`)
        // 如果沒有下一頁了，停止觀察
        if (next_page === null){
          done = true;
          observer.disconnect();
          console.log("觀察停止")
        } else {
          // 有下一頁的話將頁碼更新
          page = next_page;
        }
      } finally {
        loadding = false;
        // 重新啟動觀察，就算前面長出來的東西不夠把sentinel推出交集，還是可以再觸發一次
        if (!done) observer.observe(sentinel);
      }
    }

    // IntersectionObserver：讓瀏覽器「監控某個元素」和「某個可視區域」的交集狀態
    // entries 是一批「狀態有變化」的觀察結果（每個是 IntersectionObserverEntry）
    // isIntersecting 表示 target 目前是否和 root 有交集（至少碰到、重疊到一點點也算）
    const observer = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting){
          load_more();
        }
      }, {root: null, rootMargin: "0px 0px 50px 0px", threshold: 0}
    );
    // root null：以「整個瀏覽器視窗」當觀察視窗，element：以「某個容器」當觀察視窗（適合容器內滾動）
    // threshold 門檻，代表「交集比例」的觸發點，threshold: 0：只要有一點點交集就算（最常用於無限滾動），threshold: 1：要完全進入可視範圍才算，也可以用陣列 [0, 0.25, 0.5, 1]：跨越任一比例就觸發
    // rootMargin 把 root 的可視範圍「擴大或縮小」的偏移量（很重要）："200px 0px"：把 root 上下額外擴大 200px（通常用來「提前載入」，不用真的到底才載），也可以是 "200px 0px -80px 0px"：底部縮小 80px（例如你有 fixed footer 遮住內容時）
    
    // 啟動觀察
    observer.observe(sentinel);

    

  </script>
</body>
</html>