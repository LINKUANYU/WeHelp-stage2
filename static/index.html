<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/css/common.css">
  <link rel="stylesheet" href="/static/css/index.css">
  <title>Index</title>
</head>
<body>
  <!-- login modal -->
  <div class="modal is is-hidden" id="login-modal">
    <div class="modal__backdrop"></div>
    <div class="modal__content modal__content--login">
      <div class="modal__decorator-bar"></div>
      <div class="modal__close">
        <img class="modal__close-icon" src="/static/photo/close.png">
      </div>
      <div class="modal__body">
        <div class="modal__title u-text-headline3 u-c-sec-70">登入會員帳號</div>
        <input class="auth__input auth__input--email" placeholder="輸入電子信箱">
        <input class="auth__input auth__input--password" placeholder="輸入密碼">
        <button class="auth__submit u-bg-pri-70 u-c-white u-text-btn">登入帳戶</button>
        <div class="auth__hint u-c-sec-70 u-text-body">
          還沒有帳戶？<a class="auth__link--signup">點此註冊</a>
        </div>
      </div>
    </div>
  </div>
  <!-- signup modal -->
  <div class="modal is-hidden" id="signup-modal">
    <div class="modal__backdrop"></div>
    <div class="modal__content modal__content--signup">
      <div class="modal__decorator-bar"></div>
      <div class="modal__close">
        <img class="modal__close-icon" src="/static/photo/close.png">
      </div>
      <div class="modal__body">
        <div class="modal__title u-text-headline3 u-c-sec-70">註冊會員帳號</div>
        <input class="auth__input auth__input--name" placeholder="輸入姓名">
        <input class="auth__input auth__input--email" placeholder="輸入電子信箱">
        <input class="auth__input auth__input--password" placeholder="輸入密碼">
        <button class="auth__submit u-bg-pri-70 u-c-white u-text-btn">註冊新帳戶</button>
        <div class="auth__hint u-c-sec-70 u-text-body">
          已經有帳戶了？<a class="auth__link--login">點此登入</a>
        </div>
      </div>
    </div>
  </div>
  <!-- Header -->
  <header class="l-header">
    <div class="nav">
      <div class="nav__brand u-text-headline2 u-c-pri-70">台北一日遊</div>
      <div class="nav__menu">
        <button class="nav__btn u-text-body u-c-sec-70 u-bg-white">預定行程</button>
        <button class="nav__btn u-text-body u-c-sec-70 u-bg-white" id="login-btn">登入/註冊</button>
      </div>
    </div> 
  </header>
  <!-- Hero -->
  <div class="l-hero">
    <!-- Hero BG img -->
    <img class="hero__img" src="/static/photo/welcome.png">
    <!-- Hero content -->
    <div class="hero__content">
      <!-- Hero slogan -->
      <div class="hero__slogan">
        <div class="hero__title u-c-white u-text-sloganTitle">輕鬆享受台北一日悠閒</div>
        <div class="hero__subtitle u-c-white u-text-body--bold">探索每個角落，體驗城市的深度旅遊行程</div>
      </div>
      <!-- Hero search bar -->
      <div class="hero__search">
        <div class="search">
          <button class="search__categories-btn u-text-body">全部分類▼</button>
          <input class="search__input u-text-body--bold" placeholder="輸入景點名稱查詢" id="search__input">
          <button class="search__btn" type="submit">
            <img class="search__icon" src="/static/photo/icon_search.png">
          </button>
        </div>
      </div>
      <div class="category__menu is-hidden u-bg-white">
        <div class="category__item u-text-category">全部分類</div>
        <!-- categories 填充物 -->
      </div>
    </div>
  </div>
  <!-- Atrractions area -->
  <div class="l-attractions">
    <!-- Atrraction list bar -->
    <div class="listBar u-bg-white">
      <div class="listBar__nav--left">
        <button class="listBar__btn u-bg-white" id="listBar-left-btn">
          <img class="listBar__icon" src="/static/photo/left-btn.png">
        </button>
      </div>
      <div class="listBar__viewport">
        <div class="listBar__list">
          <!-- JS填充 -->
        </div>
      </div>
      <div class="listBar__nav--right">
        <button class="listBar__btn u-bg-white" id="listBar-right-btn">
          <img class="listBar__icon" src="/static/photo/right-btn.png">
        </button>
      </div>
    </div>
    <!-- Card grid  -->
    <div class="cardGrid">
      <!-- Card 填充物 -->
      <!-- 填充物範本 
      <a class="card u-c-white" href="">
        <div class="card__media">
          <img class="card__img" src="">
          <div class="card__title">
            <div class="card__titleText u-text-body--bold u-c-white">平安鐘</div>
          </div>
        </div>
        <div class="card__detail">
          <div class="card__info card__info--mrt u-text-body u-c-sec-50">忠孝復興</div>
          <div class="card__info card__info--category u-text-body u-c-sec-50">公共藝術</div>
        </div>
      </a>  
      -->
      
    </div>
  </div>
  <div id="sentinel"></div>
  <!-- Footer -->
  <div class="l-footer u-bg-sec-50">
    <div class="footer__text u-text-body--bold u-c-white">COPYRIGHT © 2021 台北一日遊</div>
  </div>
  <script defer>
    const bar = document.querySelector('.listBar');
    const listBar_list = bar.querySelector('.listBar__list');
    const left_btn = bar.querySelector('#listBar-left-btn');
    const right_btn = bar.querySelector('#listBar-right-btn');
    const category_menu = document.querySelector('.category__menu');
    const sentinel = document.querySelector('#sentinel');


    // 計算每次滑動的位移量，clientWidth：該元素「可視內容看」的寬度
    function step(){
      return listBar_list.clientWidth * 2 / 3;
    }
    
    left_btn.addEventListener('click',() => {
      listBar_list.scrollBy({left: -step(), behavior: "smooth"});
    });
    // scrollBy：相對捲動，left：水平捲動位移量
    right_btn.addEventListener('click',() => {
      listBar_list.scrollBy({left: step(), behavior: "smooth"});
    });

    async function get_data(url) {
      const res = await fetch(url);
      const ct = res.headers.get('content-type') || '';
      const body = ct.includes('application/json') ? await res.json() : await res.text();

      if (!res.ok){
        const err = new Error (`HTTP ${res.status}`);
        err.status = res.status;
        err.payload = body;
        throw err;
      }
      return body;
    }

    async function startup(){
      // Fetch List bar
      try{
        const search_input = document.querySelector('#search__input');
        const result = await get_data("/api/mrts");
        const data = result.data;
        data.forEach(d => {
          // create list bar item
          const listBar_item = document.createElement('div');
          listBar_item.classList = "listBar__item u-text-body u-c-sec-70";
          listBar_item.textContent = d;
          listBar_list.append(listBar_item);
          // item function: put mrt into search input
          listBar_item.addEventListener('click', () => {
            search_input.value = listBar_item.textContent;
            // 觸發搜尋
            const search_btn = document.querySelector('.search__btn');
            search_btn.click();
          });
        });
      }catch(e){
        console.log(e)
      }

      // Fetch Category Menu
      try{
        const result = await get_data("/api/categories");
        const data = result.data;
        data.forEach(d => {
          // create menu
          const category_item = document.createElement('div');
          category_item.classList = "category__item u-text-category";
          category_item.textContent = d;
          category_menu.append(category_item);
        });
      }catch(e){
        console.log(e);
      }
      const search_categories_btn = document.querySelector('.search__categories-btn');
      // category menu panel event
      search_categories_btn.addEventListener('click', () => {
      category_menu.classList.toggle('is-hidden');
      });
      // panel item replace btn text event
      const category__items = document.querySelectorAll('.category__item');
      category__items.forEach((item) => {
        item.addEventListener('click', () => {
          search_categories_btn.textContent = item.textContent + "▼";
          category_menu.classList.toggle('is-hidden');
        });
      });
      // login btn event
      


    }

    startup();


    // Load Attractions
    // initial condition
    let page = 0;
    let loadding = false;  // 因下載資料會花時間，為了避免重複迴圈
    let done = false;      // 若沒有下一頁資料done變為true
    
    // Load more Function
    async function load_more(){
      console.log("load more 開始跑")
      // 避免無限重跑
      if (loadding || done) return;
      loadding = true;

      // 觸發後先暫停observe，避免就算card內長出來的東西不夠把sentinel推出交集，這裡解掉後面重啟，確保再觸發
      console.log("loadmore observe暫停")
      observer.unobserve(sentinel);
      
      // 對應finally，確保還有下一頁資料可讀取的話，到finally再變成true
      let should_resume = false;

      try{
        console.log("這個時候load more 抓到的page:", page);
        const result = await get_attractions(page);
        const data = result.data;
        // 如果找不到資料
        if (!data || data.length === 0) {
          const no_data = document.createElement('h1');
          no_data.textContent = "NO DATA";
          card_grid.append(no_data);
          // 停止boserve
          done = true;
          observer.disconnect();
          console.log("observe停止");
          return;
        }
        // 有資料，開始建card
        build_attractions(data);

        const next_page = result.nextPage;
        // 如果沒有下一頁了，停止observe
        if (next_page === null){
          done = true;
          observer.disconnect();
          console.log("observe停止")
        } else {
          // 有下一頁的話將頁碼更新
          page = next_page;
          should_resume = true
        }
      } finally {
        loadding = false;
        // 1. 如果還有下一頁資料就重啟observe
        // 2. 避免就算card內長出來的東西不夠把sentinel推出交集，前面解掉後面重啟，確保再觸發
        if (should_resume) {
          observer.observe(sentinel);
          console.log("loadmore observe重新啟動");
        }
        
      }
    }

    // IntersectionObserver：讓瀏覽器「監控某個元素」和「某個可視區域」的交集狀態
    // entries 是一批「狀態有變化」的觀察結果（每個是 IntersectionObserverEntry）
    // isIntersecting 表示 target 目前是否和 root 有交集（至少碰到、重疊到一點點也算）
    const observer = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting){
          console.log("滾動監控被偵測到了")
          load_more();
          
        }
      }, {root: null, rootMargin: "0px 0px 0px 0px", threshold: 0}
    );
    // root null：以「整個瀏覽器視窗」當觀察視窗，element：以「某個容器」當觀察視窗（適合容器內滾動）
    // threshold 門檻，代表「交集比例」的觸發點，threshold: 0：只要有一點點交集就算（最常用於無限滾動），threshold: 1：要完全進入可視範圍才算，也可以用陣列 [0, 0.25, 0.5, 1]：跨越任一比例就觸發
    // rootMargin 把 root 的可視範圍「擴大或縮小」的偏移量（很重要）："200px 0px"：把 root 上下額外擴大 200px（通常用來「提前載入」，不用真的到底才載），也可以是 "200px 0px -80px 0px"：底部縮小 80px（例如你有 fixed footer 遮住內容時）
    
    // 啟動觀察
    console.log("最外層的observe啟動")
    observer.observe(sentinel);

    // Filtering by Category and Keyword
    const search_btn = document.querySelector('.search__btn');
    const card_grid = document.querySelector('.cardGrid');
    search_btn.addEventListener('click', (e) => {
      console.log("搜尋按鈕被觸發了")
      // 清空先前內容，reset condidtion
      card_grid.innerHTML = "";
      page = 0;
      done = false;
      loadding = false;
      // observe 重新啟動
      observer.observe(sentinel);
    });

    // Fetch attractions API
    async function get_attractions(page = 0) {
      console.log("fetch API被觸發了")
      const search__categories_btn = document.querySelector('.search__categories-btn');
      let category = search__categories_btn.textContent.replace("▼","");
      const search_input = document.querySelector('.search__input');
      const keyword = search_input.value.trim();
      if (category === "全部分類"){
        category = null;
      }
      // 組織url
      let url = `/api/attractions?page=${page}`;
      if (category && keyword){
        url += `&category=${category}&keyword=${keyword}`
      }
      else if (category){
        url += `&category=${category}`
      }
      else if (keyword){
        url += `&keyword=${keyword}`
      }
      console.log(url);
      try{
        const result = await get_data(url);
        return result;
      }catch(e){
        console.log(e);
      }
    }

    // Build Attractions HTML
    function build_attractions(data){
      console.log("開始蓋attraction card")
      const card_grid = document.querySelector('.cardGrid');
      data.forEach(d => {
        // card__media
        const card_title_text = document.createElement('div');
        card_title_text.classList = "card__titleText u-text-body--bold u-c-white";
        card_title_text.textContent = d.name;
        const card_title = document.createElement('div');
        card_title.classList = "card__title";
        card_title.append(card_title_text);
        const card_img = document.createElement('img');
        card_img.classList = "card__img";
        card_img.src = d.images[0];
        const card_media = document.createElement('div');
        card_media.classList = "card__media";
        card_media.append(card_img);
        card_media.append(card_title);
        // card__detail
        const card_info_mrt = document.createElement('div');
        card_info_mrt.classList = "card__info card__info--mrt u-text-body u-c-sec-50";
        card_info_mrt.textContent = d.mrt;
        const card_info_category = document.createElement('div');
        card_info_category.classList = "card__info card__info--category u-text-body u-c-sec-50";
        card_info_category.textContent = d.category;
        const card_detail = document.createElement('div');
        card_detail.classList = "card__detail";
        card_detail.append(card_info_mrt);
        card_detail.append(card_info_category);
        // card
        const card = document.createElement('a');
        card.classList = "card u-c-white";
        card.href = `/attraction/${d.id}`;
        card.append(card_media);
        card.append(card_detail);
        // insert card
        card_grid.append(card);
      });
    }

  </script>
</body>
</html>